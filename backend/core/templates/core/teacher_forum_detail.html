{% extends "core/base_teacher.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}{{ post.title }} - Community Forum{% endblock %}

{% block content %}
<div class="container">
    <a class="btn btn-link px-0 mb-3" href="{% url 'teacher_forum' %}"><i class="fas fa-arrow-left"></i> Back to Forum</a>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="h4">{{ post.title }}</h1>
                    <div class="text-muted small">By {{ post.author.get_full_name|default:post.author.username }} Â· {{ post.created_at|date:"M d, Y" }}</div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    {% if post.is_pinned %}<span class="badge bg-warning text-dark">Pinned</span>{% endif %}
                    {% if post.is_locked %}<span class="badge bg-danger">Locked</span>{% endif %}
                    {% if post.author == request.user or request.user.is_superuser %}
                        <a href="{% url 'teacher_forum_edit' post.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                        <form method="post" action="{% url 'teacher_forum_delete' post.id %}" onsubmit="return confirm('Delete this discussion?');" style="display:inline;">
                            {% csrf_token %}
                            <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            <hr>
            <div class="image-container mb-3">
                {% if post.image and "placeholder" in post.image.url %}
                    <img class="card-img-top" src="{% static 'core/images/default.jpg' %}" alt="placeholder image">
                {% elif post.image %}
                    <img class="card-img-top" src="{{ post.image.url }}" alt="{{ post.title }}">
                {% else %}
                    <img class="card-img-top" src="{% static 'core/images/default.jpg' %}" alt="placeholder image">
                {% endif %}
                <div class="image-flash"></div>
            </div>
            <div class="content">
                {{ post.content|safe }}
            </div>
        </div>
    </div>

    <h5 class="mb-3">Replies ({{ post.replies_count }})</h5>
    {% if post.replies.count %}
        <div class="list-group mb-4">
            {% for reply in post.replies.all %}
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <strong>{{ reply.author.get_full_name|default:reply.author.username }}</strong>
                            <small class="text-muted d-block">{{ reply.created_at|date:"M d, Y \a\t H:i" }}</small>
                        </div>
                        {% if reply.author == request.user or request.user.is_superuser %}
                            <div class="d-flex align-items-center gap-2">
                                <a href="{% url 'teacher_forum_reply_edit' post.id reply.id %}" class="btn btn-sm btn-outline-primary">Edit</a>
                                <form method="post" action="{% url 'teacher_forum_reply_delete' post.id reply.id %}" onsubmit="return confirm('Delete this reply?');" style="display:inline;">
                                    {% csrf_token %}
                                    <button class="btn btn-sm btn-outline-danger" type="submit">Delete</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                    <div class="mt-2">{{ reply.content|safe }}</div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">No replies yet.</div>
    {% endif %}

    {% if post.is_locked %}
        <div class="alert alert-warning">This thread is locked. Replies are disabled.</div>
    {% else %}
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">Add a Reply</h5>
                <form method="post">
                    {% csrf_token %}
                    {{ reply_form|crispy }}
                    <button class="btn btn-primary" type="submit">Post Reply</button>
                </form>
                <p class="small text-muted mt-3 mb-0">
                    We welcome open and respectful discussion. Please note that this comments section is monitored. Any posts containing offensive language, harassment, hate speech, spam, personal attacks, or inappropriate content may be removed at our discretion.
                </p>
            </div>
        </div>
    {% endif %}
</div>

{% block extra_js %}
    {{ reply_form.media }}
{% endblock %}
{% endblock %}
